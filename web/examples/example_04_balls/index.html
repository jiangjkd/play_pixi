<!DOCTYPE HTML>
<html>
<head>
    <title>Pixi Balls by Photon Storm</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1 maximum-scale=1 user-scalable=0"/>
    <link rel="stylesheet" href="storm.css">

</head>
<body>

<a href="http://www.photonstorm.com"><img src="assets/photonstorm.png" width="121" height="18" id="photonstorm"
                                          title="Photon Storm"/></a>
<a href="http://www.html5gamedevs.com/topic/59-pixijs-has-landed/"><img src="assets/pixi.png" width="56" height="22"
                                                                        id="pixi" title="pixi.js"/></a>
<button type="button" id="rnd" value="Randomise">Randomise</button>

<div id="sx">SX: 0<br/>SY: 0</div>

<script type="application/dart">
    import "dart:html";
    import "dart:math";
    import "package:pixi_dart/pixi.dart" as PIXI;

    main() {
        Random random = new Random();

        num w = 1024;
        num h = 768;
        num starCount = 2500;
        num sx = 1.0 + (random.nextDouble() / 20);
        num sy = 1.0 + (random.nextDouble() / 20);
        num slideX = w / 2;
        num slideY = h / 2;
        List stars = [];
        var renderer;
        PIXI.Stage stage;


        newWave(e) {
            sx = 1.0 + (random.nextDouble() / 20);
            sy = 1.0 + (random.nextDouble() / 20);
            document.getElementById('sx').innerHtml = 'SX: ' + sx + '<br />SY: ' + sy;
        }

        resize([e]) {

            w = window.innerWidth - 16;
            h = window.innerHeight - 16;

            slideX = w / 2;
            slideY = h / 2;

            renderer.resize(w, h);
        }

        update([dt]) {
            for (var i = 0; i < starCount; i++) {
                stars[i]['sprite'].position.x = stars[i]['x'] + slideX;
                stars[i]['sprite'].position.y = stars[i]['y'] + slideY;
                stars[i]['x'] = stars[i]['x'] * sx;
                stars[i]['y'] = stars[i]['y'] * sy;

                if (stars[i]['x'] > w) {
                    stars[i]['x'] = stars[i]['x'] - w;
                }
                else if (stars[i]['x'] < -w) {
                    stars[i]['x'] = stars[i]['x'] + w;
                }

                if (stars[i]['y'] > h) {
                    stars[i]['y'] = stars[i]['y'] - h;
                }
                else if (stars[i]['y'] < -h) {
                    stars[i]['y'] = stars[i]['y'] + h;
                }
            }

            renderer.render(stage);

            PIXI.requestAnimFrame(update);
        }


        start() {
            //print(w);
            PIXI.Texture ballTexture = PIXI.Texture.fromImage("assets/bubble_32x32.png");
            renderer = PIXI.autoDetectRenderer(w, h);
            stage = new PIXI.Stage();

            document.body.append(renderer.view);

            for (var i = 0; i < starCount; i++) {
                var tempBall = new PIXI.Sprite(ballTexture);

                tempBall.position.x = random.nextInt(w) - slideX;
                tempBall.position.y = random.nextInt(h) - slideY;
                tempBall.anchor.x = 0.5;
                tempBall.anchor.y = 0.5;

                stars.add({
                        'sprite': tempBall, 'x': tempBall.position.x, 'y': tempBall.position.y
                });

                stage.addChild(tempBall);
            }

            document.getElementById('rnd').onClick.listen(newWave);
            document.getElementById('sx').innerHtml = 'SX:  $sx <br />SY: $sy';

            resize();

            PIXI.requestAnimFrame(update);
        }


        window.onResize.listen(resize);

        start();
    }


</script>
<script type="text/javascript" src="packages/browser/dart.js"></script>

</body>
</html>
